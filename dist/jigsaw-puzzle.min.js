var jigsawPuzzle=function(e){"use strict";const t=e=>t=>(e(t),t),i=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),n=e=>t=>i=>("function"==typeof t?t(i):t)?e(i):i,o=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),s=e=>JSON.parse(JSON.stringify(e)),a=(e,t,i)=>{const n=e+1,o={top:n>i?e-i:void 0,right:n%i!=0?e+1:void 0,bottom:n<=(t-1)*i?e+i:void 0,left:n%i!=(i>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(o))},c=["top","right","bottom","left"],r=["top","right","bottom","left"],d=(e,t)=>r.indexOf(e[0])>r.indexOf(t[0])?1:-1,p=(e,t)=>{const n=(t,i)=>e.find((e=>e.id===t))?.sides[{top:"bottom",right:"left",bottom:"top",left:"right"}[i]],o=[...Object.entries({...(({neighbors:e})=>Object.keys(e).reduce(((t,o)=>{const s=n(e[o],o);return{[o]:s?(a=s,"out"===a?"in":"out"):i()>=.5?"out":"in",...t};var a}),{}))(t),...(({neighbors:e})=>c.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(t)})].sort(d).reduce(((e,[t,i])=>({...e,[t]:i})),{});return[{...t,sides:o},...e]},l=e=>[...new Set(e)],h=(e,t)=>t.active?-1:1,u=e=>t=>t.reduceRight(((t,i,n,o)=>[...t,e(i,n,o,t)]),[]);function x(e){const t=[...e];let i=t.length;for(;i>0;){let e=Math.floor(Math.random()*i);i--;let n=t[i];t[i]=t[e],t[e]=n}return t}const y=e=>Math.random()*(e- -1*e)+-1*e,m=(e=!1)=>t=>({...t,pieces:e?x(t.pieces).map(((e,i)=>({...e,connections:[],pos:{x:i%t.size.x/t.size.x*2-.4+y(.03),y:Math.floor(i/t.size.x)/t.size.y*2-.4+y(.03)}}))):t.pieces.map((e=>({...e,connections:[],pos:{x:2*i()-.5,y:2*i()-.5}})))}),f=(e,{x:t,y:i,width:n,height:o})=>t>=e.pos.x&&t<=e.pos.x+n&&i>=e.pos.y&&i<=e.pos.y+o,g=(e,{x:t,y:i})=>({x:t-e.pos.x,y:i-e.pos.y}),v=t((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))})),z=(e,t)=>i=>i[e]===t,w=t((e=>{const t=e.pieces.filter((e=>e.active)),{size:i}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([n,o])=>{const s=e.pieces.find(z("id",o));if(((e,t,i,n)=>{const{attraction:o,size:s}=i,a=o/100,c=(e=>"top"===e||"bottom"===e)(n)?"y":"x",r="x"===c?"y":"x",d=!(e=>"top"===e||"left"===e)(n),p="y"===c?1/s.y:1/s.x,l=d?t.pos[c]+p:t.pos[c]-p;return e.pos[c]<=l+a&&e.pos[c]>=l-a&&e.pos[r]<=t.pos[r]+a&&e.pos[r]>=t.pos[r]-a})(s,t,e,n)){const o={x:s.pos.x+("right"===n?-1/i.x:"left"===n?1/i.x:0),y:s.pos.y+("top"===n?1/i.y:"bottom"===n?-1/i.y:0)};((e,[...t],i)=>{t.forEach((t=>{const n=e.pieces.find(z("id",t));n.pos={x:n.pos.x+i.x,y:n.pos.y+i.y}}))})(e,t.connections,{x:o.x-t.pos.x,y:o.y-t.pos.y}),t.pos=o,((e,t,i)=>{t.connections=l([t.id,i.id,...t.connections,...i.connections]),t.connections.forEach((i=>{const n=e.pieces.find((e=>e.id===i));n.connections=l(t.connections)})),i.connections.forEach((i=>{const n=e.pieces.find((e=>e.id===i));n.connections=l(t.connections)}))})(e,t,s)}}))}))})),b=t((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),M=({x:e,y:i})=>t((t=>{const n=t.pieces.find((e=>e.active));if(n)return void(t.status="active");!t.pieces.find((n=>f(n,{x:e,y:i,width:1/t.size.x,height:1/t.size.y})))||n?t.status="idle":t.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),i=new Uint32Array(t.data.buffer),n=(e,n)=>i[n*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==n(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===n(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function i(e,t,i,n,o,s,a,c,r){const{width:d,height:p}=function(e){const t=t=>{const i=globalThis[t];return i&&e instanceof i};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);n<0&&(t+=n,n=Math.abs(n)),o<0&&(i+=o,o=Math.abs(o)),c<0&&(s+=c,c=Math.abs(c)),r<0&&(a+=r,r=Math.abs(r));const l=Math.max(t,0),h=Math.min(t+n,d),u=Math.max(i,0),x=Math.min(i+o,p),y=c/n,m=r/o;return[e,l,u,h-l,x-u,t<0?s-t*y:s,i<0?a-i*m:a,(h-l)*y,(x-u)*m]}function n(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,o,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const c=i(...arguments);return n(c)?void 0:t.apply(this,c)}:console.error("This script requires a basic implementation of drawImage")})();let E=1;const S={x:window.innerWidth/2,y:window.innerHeight/2},C=({focal:e,zoom:t,max:i=1e4,min:n=.05})=>{const o=E===i||E===n;E=((e,t,i)=>Math.max(t,Math.min(i,e)))(E*t,n,i);const s=o?S.x:e.x,a=o?S.y:e.y;return S.x=s-(s-S.x)*t,S.y=a-(a-S.y)*t,{position:S,scale:E}};var I=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:i=null,initScale:n=1}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehaviour="contain",E=n;const o=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};return setTimeout((()=>o({scale:E,position:S}))),{zoom:e=>{C({focal:{x:window.innerWidth/2*t,y:window.innerHeight/2*t},zoom:e}),o({scale:E,position:S})},restore:()=>{S.x=window.innerWidth/2*Math.min(2,window.devicePixelRatio),S.y=window.innerHeight/2*Math.min(2,window.devicePixelRatio),o({scale:E,position:S})}}};const O=e=>{const{height:t,width:i}=getComputedStyle(e.parentElement),n=Math.min(2,window.devicePixelRatio);e.width=parseInt(i,0)*n,e.height=parseInt(t,0)*n},P=t((e=>{const{canvas:t,ctx:i}=e;i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,t.width,t.height),i.restore()})),T=e=>t((t=>{P(t),e.pieces.map(R(e,t))})),R=(e,t)=>i=>{const n={x:i.pos.x*t.size.x,y:i.pos.y*t.size.y},o={x:t.size.x/e.size.x,y:t.size.y/e.size.y},s=t.shapes[i.id],{ctx:a,image:c}=t,r=Math.max(o.x,o.y);a.save(),a.translate(n.x,n.y);const d=!e.done&&(i.active||i.alsoActive),p=4/Math.max(t.zoom,2);a.shadowColor=d?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",a.shadowBlur=p,a.shadowOffsetX=a.shadowOffsetY=-p/2,a.lineWidth=d?2*p:p,a.stroke(s),a.clip(s),a.drawImage(c,i.origin.x*o.x-r,i.origin.y*o.y-r,o.x+2*r,o.y+2*r,i.pos.x/t.size.x-r,i.pos.y/t.size.y-r,o.x+2*r,o.y+2*r),a.restore()},A=(e,t,...i)=>{const n=t*Math.PI/180,{sin:o,cos:s}=Math;return i.map((([t,i])=>[(t-e.x)*s(n)-(i-e.y)*o(n)+e.x,(t-e.x)*o(n)+(i-e.y)*s(n)+e.y])).flat()},N=(e,t)=>{const[i]=e[0];return e.map((e=>A({x:i[0],y:i[1]},t,...e)))},k=(e,t)=>e.map((e=>e.map((e=>[e[0]+t.x,e[1]+t.y])))),H=({size:e,shapes:t,knobsize:i})=>{const n=new Path2D;if(4===!t.length)return void console.log("a piece needs to have 4 sides");const o=[0,90,180,270];return[{x:0,y:0},{x:e.x,y:0},{x:e.x,y:e.y},{x:0,y:e.y}].forEach(((s,a)=>{const c=a%2==1?e.y:e.x,r=t[a];if("flat"===r){const e=A(s,o[a],[s.x+c,s.y]);n.lineTo(...e)}else{const e=(({knobsize:e=1,length:t=100})=>{const i=t/2;return[[[0,0],[i-20*e,4*e],[i-13*e,0]],[[i-13*e,0],[i-10*e,-2*e],[i-12*e,-5*e]],[[i-12*e,-5*e],[i-30*e,-30*e],[i,-30*e]],[[i,-30*e],[i- -30*e,-30*e],[i- -12*e,-5*e]],[[i- -12*e,-5*e],[i- -10*e,-2*e],[i- -13*e,0]],[[i- -13*e,0],[i- -20*e,4*e],[t,0]]]})({length:c,knobsize:i});N(k("in"===r?((e,t=1)=>e.map((e=>e.map((e=>[e[0]*t,-1*e[1]])))))(e):e,s),o[a]).forEach((e=>n.bezierCurveTo(...e.flat())))}})),n.closePath(),n},L=(e,t,i)=>i.reduce(((i,n)=>({...i,[n.id]:H({size:{x:e,y:t},shapes:Object.values(n.sides),knobsize:Math.min(e,t)/110})})),{});return e.puzzle=async({element:e,image:i="",pieces:c={x:6,y:4},attraction:r=5,aligned:d=!1,zoom:l,beforeInit:x=(()=>{}),onInit:y=(()=>{}),onComplete:z=(()=>{}),onChange:C=(()=>{})})=>{const P="string"==typeof e?document.querySelector(e):e;if(!P)return void console.warn(`Couldn't find element: ${e}`);const{canvas:R,ctx:A}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),i=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",O(t)),i.strokeStyle="rgba(220, 220, 220, 1)",i.lineCap="round",i.lineJoin="round",{canvas:t,ctx:i}})(P);x(R);const{image:N,width:k,height:H}=await(j=i,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=j})));var j;const W={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:r,size:c,pieces:(V=c,[...Array(V.y*V.x)].map(((e,t)=>({id:t,origin:{x:t%V.x,y:Math.floor(t/V.x)},pos:{x:0,y:0},neighbors:a(t,V.y,V.x),active:!1,connections:[]}))).reduce(p,[]))};var V;const D={url:i,zoom:1,position:{x:0,y:0},size:{x:k,y:H},canvas:R,ctx:A,image:N,dpi:Math.min(2,window.devicePixelRatio),shapes:L(k/c.x,H/c.y,W.pieces)};let J={};J.puzzle=o(m(d))(W),J.ui=T(J.puzzle)(D);const{zoom:X,restore:Y}=I(R,{dpi:Math.min(2,window.devicePixelRatio),initScale:l||Math.min(window.innerWidth/J.ui.size.x*.9,window.innerHeight/J.ui.size.y*.9)}),B=()=>{J.ui=o(T(J.puzzle),(e=>t((t=>{t.canvas.style.cursor="active"===e.status?"grabbing":"ready"===e.status?"grab":"default"})))(J.puzzle))(J.ui)};R.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:i}}=e;J.ui.zoom=t,J.ui.position=i,J.ui.ctx.setTransform(t,0,0,t,i.x,i.y),B()})),setTimeout((()=>y(J)));const G=({x:e,y:t})=>{const[i,n]=(({x:e,y:t},i=Math.min(2,window.devicePixelRatio))=>[(e*i-S.x)/E,(t*i-S.y)/E])({x:e,y:t},Math.min(2,window.devicePixelRatio));return{x:i/J.ui.size.x,y:n/J.ui.size.y}};return J.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const i=G({x:e,y:t});J.puzzle=o((({x:e,y:t})=>i=>{return{...i,pieces:o(u(((n,o,s,a)=>{return{...n,active:!(a.find((c="active",e=>e[c]))||!f(n,{x:e,y:t,width:1/i.size.x,height:1/i.size.y}))&&g(n,{x:e,y:t})};var c})),u(((i,n,o)=>({...i,active:o.find((e=>e.active&&e.connections.includes(i.id)))?g(i,{x:e,y:t}):i.active}))),n((s=h,e=>e.sort(s)))((e=>!i.done&&e.filter((e=>e.active)).length!==i.pieces.length)))(i.pieces)};var s})(i),M(i))(J.puzzle),B()})),J.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const i=G({x:e,y:t});J.puzzle=o((({x:e,y:t})=>i=>({...i,pieces:"idle"===i.status?i.pieces:i.pieces.map((i=>({...i,pos:i.active?{x:e-i.active.x,y:t-i.active.y}:i.pos})))}))(i),M(i))(J.puzzle),B()})),J.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const i=G({x:e,y:t});J.puzzle=o(w,v,b,M(i))(J.puzzle),B(),C({ui:J.ui,puzzle:s(J.puzzle)}),J.puzzle.done&&z(J)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=J.ui;O(J.ui.canvas),A.setTransform(e,0,0,e,t.x,t.y),B()})),{newGame:()=>{J.puzzle=o(m(d))(W),B()},getState:()=>s(J.puzzle),setState:e=>{J.puzzle=e,B()},destroy:()=>{"CANVAS"!==e.tagName&&J.ui.canvas.remove(),J=null},setZoom:X,getZoom:()=>J.ui.zoom,centralize:Y}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=e=>t=>(e(t),t),t=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),o=e=>t=>o=>("function"==typeof t?t(o):t)?e(o):o,i=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),n=e=>JSON.parse(JSON.stringify(e)),s=(e,t,o)=>{const i=e+1,n={top:i>o?e-o:void 0,right:i%o!=0?e+1:void 0,bottom:i<=(t-1)*o?e+o:void 0,left:i%o!=(o>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(n))},a=["top","right","bottom","left"],c=["top","right","bottom","left"],r=(e,t)=>c.indexOf(e[0])>c.indexOf(t[0])?1:-1,p=(e,o)=>{const i=(t,o)=>e.find((e=>e.id===t))?.sides[{top:"bottom",right:"left",bottom:"top",left:"right"}[o]],n=[...Object.entries({...(({neighbors:e})=>Object.keys(e).reduce(((o,n)=>{const s=i(e[n],n);return{[n]:s?(a=s,"out"===a?"in":"out"):t()>=.5?"out":"in",...o};var a}),{}))(o),...(({neighbors:e})=>a.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(o)})].sort(r).reduce(((e,[t,o])=>({...e,[t]:o})),{});return[{...o,sides:n},...e]},d=e=>[...new Set(e)],l=(e,t)=>t.active?-1:1,u=e=>t=>t.reduceRight(((t,o,i,n)=>[...t,e(o,i,n,t)]),[]);function h(e){const t=[...e];let o=t.length;for(;o>0;){let e=Math.floor(Math.random()*o);o--;let i=t[o];t[o]=t[e],t[e]=i}return t}const y=e=>Math.random()*(e- -1*e)+-1*e,x=(e=!1)=>o=>({...o,pieces:e?h(o.pieces).map(((e,t)=>({...e,connections:[],pos:{x:t%o.size.x/o.size.x*2-.4+y(.03),y:Math.floor(t/o.size.x)/o.size.y*2-.4+y(.03)}}))):o.pieces.map((e=>({...e,connections:[],pos:{x:2*t()-.5,y:2*t()-.5}})))}),m=(e,{x:t,y:o,width:i,height:n})=>t>=e.pos.x&&t<=e.pos.x+i&&o>=e.pos.y&&o<=e.pos.y+n,f=(e,{x:t,y:o})=>({x:t-e.pos.x,y:o-e.pos.y}),g=e((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))})),z=(e,t)=>o=>o[e]===t,v=e((e=>{const t=e.pieces.filter((e=>e.active)),{size:o}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([i,n])=>{const s=e.pieces.find(z("id",n));if(((e,t,o,i)=>{const{attraction:n,size:s}=o,a=n/100,c=(e=>"top"===e||"bottom"===e)(i)?"y":"x",r="x"===c?"y":"x",p=!(e=>"top"===e||"left"===e)(i),d="y"===c?1/s.y:1/s.x,l=p?t.pos[c]+d:t.pos[c]-d;return e.pos[c]<=l+a&&e.pos[c]>=l-a&&e.pos[r]<=t.pos[r]+a&&e.pos[r]>=t.pos[r]-a})(s,t,e,i)){const n={x:s.pos.x+("right"===i?-1/o.x:"left"===i?1/o.x:0),y:s.pos.y+("top"===i?1/o.y:"bottom"===i?-1/o.y:0)};((e,[...t],o)=>{t.forEach((t=>{const i=e.pieces.find(z("id",t));i.pos={x:i.pos.x+o.x,y:i.pos.y+o.y}}))})(e,t.connections,{x:n.x-t.pos.x,y:n.y-t.pos.y}),t.pos=n,((e,t,o)=>{t.connections=d([t.id,o.id,...t.connections,...o.connections]),t.connections.forEach((o=>{const i=e.pieces.find((e=>e.id===o));i.connections=d(t.connections)})),o.connections.forEach((o=>{const i=e.pieces.find((e=>e.id===o));i.connections=d(t.connections)}))})(e,t,s)}}))}))})),w=e((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),b=({x:t,y:o})=>e((e=>{const i=e.pieces.find((e=>e.active));if(i)return void(e.status="active");!e.pieces.find((i=>m(i,{x:t,y:o,width:1/e.size.x,height:1/e.size.y})))||i?e.status="idle":e.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),o=new Uint32Array(t.data.buffer),i=(e,i)=>o[i*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==i(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===i(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function o(e,t,o,i,n,s,a,c,r){const{width:p,height:d}=function(e){const t=t=>{const o=globalThis[t];return o&&e instanceof o};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);i<0&&(t+=i,i=Math.abs(i)),n<0&&(o+=n,n=Math.abs(n)),c<0&&(s+=c,c=Math.abs(c)),r<0&&(a+=r,r=Math.abs(r));const l=Math.max(t,0),u=Math.min(t+i,p),h=Math.max(o,0),y=Math.min(o+n,d),x=c/i,m=r/n;return[e,l,h,u-l,y-h,t<0?s-t*x:s,o<0?a-o*m:a,(u-l)*x,(y-h)*m]}function i(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,n,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const c=o(...arguments);return i(c)?void 0:t.apply(this,c)}:console.error("This script requires a basic implementation of drawImage")})();let M=1;const E={x:350,y:250},S=({focal:e,zoom:t,max:o=1e4,min:i=.05})=>{const n=M===o||M===i;M=((e,t,o)=>Math.max(t,Math.min(o,e)))(M*t,i,o);const s=n?E.x:e.x,a=n?E.y:e.y;return E.x=s-(s-E.x)*t,E.y=a-(a-E.y)*t,{position:E,scale:M}};var C=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:o=null,initScale:i=1}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehaviour="contain",M=i;const n=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};return setTimeout((()=>n({scale:M,position:E}))),{zoom:e=>{S({focal:{x:window.innerWidth/2*t,y:window.innerHeight/2*t},zoom:e}),n({scale:M,position:E})},restore:()=>{console.log("RESTORE"),E.x=0,E.y=0,n({scale:M,position:E})}}};const I=e=>{const{height:t,width:o}=getComputedStyle(e.parentElement);e.width=parseInt(o,0),e.height=parseInt(t,0)},O=e((e=>{const{canvas:t,ctx:o}=e;o.save(),o.setTransform(1,0,0,1,0,0),o.clearRect(0,0,t.width,t.height),o.restore()})),T=t=>e((e=>{O(e),t.pieces.map(A(t,e))})),A=(e,t)=>o=>{const i={x:o.pos.x*t.size.x,y:o.pos.y*t.size.y},n={x:t.size.x/e.size.x,y:t.size.y/e.size.y},s=t.shapes[o.id],{ctx:a,image:c}=t,r=Math.max(n.x,n.y);a.save(),a.translate(i.x,i.y);const p=!e.done&&(o.active||o.alsoActive),d=4/Math.max(t.zoom,2);a.shadowColor=p?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",a.shadowBlur=d,a.shadowOffsetX=a.shadowOffsetY=-d/2,a.lineWidth=p?2*d:d,a.stroke(s),a.clip(s),a.drawImage(c,o.origin.x*n.x-r,o.origin.y*n.y-r,n.x+2*r,n.y+2*r,o.pos.x/t.size.x-r,o.pos.y/t.size.y-r,n.x+2*r,n.y+2*r),a.restore()},N=(e,t,...o)=>{const i=t*Math.PI/180,{sin:n,cos:s}=Math;return o.map((([t,o])=>[(t-e.x)*s(i)-(o-e.y)*n(i)+e.x,(t-e.x)*n(i)+(o-e.y)*s(i)+e.y])).flat()},k=(e,t)=>{const[o]=e[0];return e.map((e=>N({x:o[0],y:o[1]},t,...e)))},R=(e,t)=>e.map((e=>e.map((e=>[e[0]+t.x,e[1]+t.y])))),L=({size:e,shapes:t,knobsize:o})=>{const i=new Path2D;if(4===!t.length)return void console.log("a piece needs to have 4 sides");const n=[0,90,180,270];return[{x:0,y:0},{x:e.x,y:0},{x:e.x,y:e.y},{x:0,y:e.y}].forEach(((s,a)=>{const c=a%2==1?e.y:e.x,r=t[a];if("flat"===r){const e=N(s,n[a],[s.x+c,s.y]);i.lineTo(...e)}else{const e=(({knobsize:e=1,length:t=100})=>{const o=t/2;return[[[0,0],[o-20*e,4*e],[o-13*e,0]],[[o-13*e,0],[o-10*e,-2*e],[o-12*e,-5*e]],[[o-12*e,-5*e],[o-30*e,-30*e],[o,-30*e]],[[o,-30*e],[o- -30*e,-30*e],[o- -12*e,-5*e]],[[o- -12*e,-5*e],[o- -10*e,-2*e],[o- -13*e,0]],[[o- -13*e,0],[o- -20*e,4*e],[t,0]]]})({length:c,knobsize:o});k(R("in"===r?((e,t=1)=>e.map((e=>e.map((e=>[e[0]*t,-1*e[1]])))))(e):e,s),n[a]).forEach((e=>i.bezierCurveTo(...e.flat())))}})),i.closePath(),i},P=(e,t,o)=>o.reduce(((o,i)=>({...o,[i.id]:L({size:{x:e,y:t},shapes:Object.values(i.sides),knobsize:Math.min(e,t)/110})})),{});exports.puzzle=async({element:t,image:a="",pieces:c={x:6,y:4},attraction:r=5,aligned:d=!1,zoom:h,beforeInit:y=(()=>{}),onInit:z=(()=>{}),onComplete:S=(()=>{}),onChange:O=(()=>{})})=>{const A="string"==typeof t?document.querySelector(t):t;if(!A)return void console.warn(`Couldn't find element: ${t}`);const{canvas:N,ctx:k}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),o=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",I(t)),o.strokeStyle="rgba(220, 220, 220, 1)",o.lineCap="round",o.lineJoin="round",{canvas:t,ctx:o}})(A);y(N);const{image:R,width:L,height:H}=await(j=a,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=j})));var j;const V={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:r,size:c,pieces:(D=c,[...Array(D.y*D.x)].map(((e,t)=>({id:t,origin:{x:t%D.x,y:Math.floor(t/D.x)},pos:{x:0,y:0},neighbors:s(t,D.y,D.x),active:!1,connections:[]}))).reduce(p,[]))};var D;const J={url:a,zoom:1,position:{x:0,y:0},size:{x:L,y:H},canvas:N,ctx:k,image:R,dpi:Math.min(2,window.devicePixelRatio),shapes:P(L/c.x,H/c.y,V.pieces)};let W={};W.puzzle=i(x(d))(V),W.ui=T(W.puzzle)(J);const{zoom:X,restore:Y}=C(N,{dpi:Math.min(2,window.devicePixelRatio),initScale:h||Math.min(window.innerWidth/W.ui.size.x*.9,window.innerHeight/W.ui.size.y*.9)}),B=()=>{W.ui=i(T(W.puzzle),(t=>e((e=>{e.canvas.style.cursor="active"===t.status?"grabbing":"ready"===t.status?"grab":"default"})))(W.puzzle))(W.ui)};N.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:o}}=e;W.ui.zoom=t,W.ui.position=o,W.ui.ctx.setTransform(t,0,0,t,o.x,o.y),B()})),setTimeout((()=>z(W)));const G=({x:e,y:t})=>{const[o,i]=(({x:e,y:t},o)=>[(e*o-E.x)/M,(t*o-E.y)/M])({x:e,y:t},1);return{x:o/W.ui.size.x,y:i/W.ui.size.y}};return W.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const n=G({x:e,y:t});W.puzzle=i((({x:e,y:t})=>n=>{return{...n,pieces:i(u(((o,i,s,a)=>{return{...o,active:!(a.find((c="active",e=>e[c]))||!m(o,{x:e,y:t,width:1/n.size.x,height:1/n.size.y}))&&f(o,{x:e,y:t})};var c})),u(((o,i,n)=>({...o,active:n.find((e=>e.active&&e.connections.includes(o.id)))?f(o,{x:e,y:t}):o.active}))),o((s=l,e=>e.sort(s)))((e=>!n.done&&e.filter((e=>e.active)).length!==n.pieces.length)))(n.pieces)};var s})(n),b(n))(W.puzzle),B()})),W.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const o=G({x:e,y:t});W.puzzle=i((({x:e,y:t})=>o=>({...o,pieces:"idle"===o.status?o.pieces:o.pieces.map((o=>({...o,pos:o.active?{x:e-o.active.x,y:t-o.active.y}:o.pos})))}))(o),b(o))(W.puzzle),B()})),W.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const o=G({x:e,y:t});W.puzzle=i(v,g,w,b(o))(W.puzzle),B(),O({ui:W.ui,puzzle:n(W.puzzle)}),W.puzzle.done&&S(W)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=W.ui;I(W.ui.canvas),k.setTransform(e,0,0,e,t.x,t.y),B()})),{newGame:()=>{W.puzzle=i(x(d))(V),B()},getState:()=>n(W.puzzle),setState:e=>{W.puzzle=e,B()},destroy:()=>{"CANVAS"!==t.tagName&&W.ui.canvas.remove(),W=null},setZoom:X,getZoom:()=>W.ui.zoom,centralize:Y}};
